# Overview

The `Hartree` module is responsible for calculations related to the Hartree energy, potential, and stress. The Hartree term accounts for the classical electrostatic Coulomb interaction between electrons. It is a fundamental component in electronic structure calculations, particularly within Density Functional Theory (DFT) or Hartree-Fock methods.

The calculations typically involve solving Poisson's equation for the electric potential generated by the electron density. In reciprocal space, this is conveniently expressed as `V_H(G) = 4*pi*rho(G) / G^2`, where `rho(G)` is the Fourier transform of the electron density and `G` is a reciprocal lattice vector. A special handling for the `G=0` (DC component) is required, as it usually cancels out with contributions from the ionic background and self-interaction terms, or is set to zero to avoid divergence.

# Key Components

- **`MODULE Hartree`**: The main container for Hartree-related calculations.

- **`FUNCTION SqrtPreconditioner(rhoRecip) RESULT(preconditioner_real)`**:
  - **Description:** Calculates a real-space potential intended for use as a preconditioner, likely in optimization schemes involving the square root of the density (`phi = sqrt(rho)`). It computes the Coulomb potential from a given reciprocal-space density `rhoRecip`. The `G=0` component of the potential is explicitly set to zero before transforming back to real space.
  - **Arguments:**
    - `rhoRecip :: REAL(KIND=DP), DIMENSION(0:,0:,0:), INTENT(IN)`: Input electron density in reciprocal space (assumed spin-neutral). The dimensions are flexible but practically map to the FFT grid.
  - **Return Value:**
    - `preconditioner_real :: REAL(KIND=DP), DIMENSION(0:SIZE(rhoRecip,1)-1, ..., 1)`: The calculated preconditioner potential in real space, shaped as a 4D array with the last dimension being 1.

- **`SUBROUTINE JPotentialPlus(rhoReal, potential, calcEnergy, energy)`**:
  - **Description:** Calculates the Hartree potential `V_H(r)` in real space from the real-space electron density `rhoReal`. It performs a forward FFT of `rhoReal`, computes `4*pi*rho(G) / G^2` in reciprocal space (setting the `G=0` term to zero), and then performs a backward FFT to get `V_H(r)`. If `calcEnergy` is true, it also computes the Hartree energy, `E_H = 0.5 * integral(rho(r) * V_H(r) dr)`.
  - **Arguments:**
    - `rhoReal :: REAL(KIND=DP), DIMENSION(:,:,:), INTENT(IN)`: Spin-neutral electron density in real space.
    - `potential :: REAL(KIND=DP), DIMENSION(:,:,:), INTENT(OUT)`: The calculated real-space Hartree potential.
    - `calcEnergy :: LOGICAL, INTENT(IN)`: A flag indicating whether to calculate the Hartree energy.
    - `energy :: REAL(KIND=DP), INTENT(OUT)`: The calculated Hartree energy (if `calcEnergy` is true).

- **`FUNCTION JStress(cellVol, rhoQ, energy) RESULT(stress_tensor)`**:
  - **Description:** Calculates the contribution of the Hartree term to the electronic stress tensor. This involves a sum over reciprocal lattice vectors `G`, using the reciprocal space density `rhoQ` and the components of `G`.
  - **Arguments:**
    - `cellVol :: REAL(KIND=DP), INTENT(IN)`: The volume of the simulation cell.
    - `rhoQ :: COMPLEX(KIND=DP), DIMENSION(:,:,:), INTENT(IN)`: Electron density in reciprocal space (spin-neutral).
    - `energy :: REAL(KIND=DP), INTENT(IN)`: The pre-calculated Hartree energy.
  - **Return Value:**
    - `stress_tensor :: REAL(KIND=DP), DIMENSION(3,3)`: The 3x3 Hartree stress tensor.

# Important Variables/Constants

- **`qTable :: REAL(KIND=DP), DIMENSION(k1G,k2G,k3G)`**: (Imported from `PlaneWave`) An array containing the squared magnitudes (`G^2`) of the reciprocal lattice vectors for each point on the FFT grid. This is essential for the `1/G^2` factor in Hartree calculations. It's temporarily modified at `G=0` to avoid division by zero.
- **`qMask :: LOGICAL, DIMENSION(k1G,k2G,k3G)`**: (Imported from `PlaneWave`) A mask, likely to exclude certain G-vectors from sums if necessary, used in `JStress`.
- **`qVectors :: REAL(KIND=DP), DIMENSION(k1G,k2G,k3G,3)`**: (Imported from `PlaneWave`) An array containing the Cartesian components `(Gx, Gy, Gz)` for each G-vector on the FFT grid, used in `JStress`.
- **`k1G, k2G, k3G, k3Goff`**: (Imported from `CellInfo`) Dimensions and offset for the reciprocal space FFT grid.

# Usage Examples

[If applicable, provide examples or code snippets demonstrating how to use the functions, classes, or modules in the file.]

# Dependencies and Interactions

- **`CONSTANTS`**: For `DP` (double precision kind parameter) and `PI`. The constant `auToGPa` is also imported but not used in the provided snippet of this module.
- **`PlaneWave`**: For `qTable` (G^2 values), `qMask`, `qVectors` (G-vector components), and `WrapQ` (a function to handle G-vector indexing, possibly for different grid layouts or symmetries).
- **`MathFunctions`**: For `Vecmul` (vector multiplication by matrix), though not explicitly used in the visible code of this module, it's listed in a `USE` statement.
- **`Fourier`**: For the `FFT` generic interface, used to transform densities between real and reciprocal space.
- **`CellInfo`**: For reciprocal space grid dimensions (`k1G`, `k2G`, `k3G`), the z-offset for parallel execution (`k3Goff`), and the global z-dimension of the reciprocal grid (`m3G` - used in `JStress` for parallel scaling).

The `Hartree` module is a core component for calculating electron-electron interactions. It relies heavily on FFTs (via the `Fourier` module) and pre-calculated information about the reciprocal space grid (via the `PlaneWave` and `CellInfo` modules). Its outputs (potential, energy, stress) are fundamental inputs for the self-consistency cycle, force calculations, and cell optimization algorithms.
