# Overview

The `KEDF_WT` module implements the Wang-Teter (WT) nonlocal Kinetic Energy Density Functional (KEDF), as described in "Kinetic-energy functional of the electron density," Phys. Rev. B. 45, 13196 (1992) by Lin-Wang Wang and Michael P. Teter. The WT KEDF is known for its good performance, particularly for light metals.

It introduces nonlocality through a kernel function that depends on a reference electron density (typically `rho0` or `rhoS`). The energy expression involves convolutions of powers of the electron density, `rho^alpha` and `rho^beta`, with this kernel in reciprocal space. This module provides routines to calculate the WT kinetic energy, its corresponding potential, and its contribution to the stress tensor.

# Key Components

- **`MODULE KEDF_WT`**: The main container for WT KEDF functionalities.

- **`SUBROUTINE WTPotentialPlus(rho, potential, calcEnergy, energy, vacCutoff)`**:
  - **Description:** This is an interface subroutine that calls `WTPotPlus` to perform the main calculation for the WT potential and energy.
  - **Arguments:**
    - `rho :: REAL(KIND=DP), DIMENSION(:,:,:), INTENT(IN)`: Spin-independent electron density.
    - `potential :: REAL(KIND=DP), DIMENSION(:,:,:), INTENT(OUT)`: Output WT potential contribution.
    - `calcEnergy :: LOGICAL, INTENT(IN)`: If `.TRUE.`, calculates the WT energy.
    - `energy :: REAL(KIND=DP), INTENT(OUT)`: Calculated WT energy.
    - `vacCutoff :: LOGICAL, INTENT(IN)`: If `.TRUE.`, applies vacuum cutoff functions.

- **`SUBROUTINE WTPotPlus(rho, potential, calcEnergy, energy, vacCutoff)`**:
  - **Description:** Calculates the Wang-Teter kinetic potential and, optionally, the energy. The WT KEDF involves terms like `rho^alpha` convolved with `(kernel * FFT(rho^beta))`. If `vacCutoff` is enabled, `CutoffFunc` (from `KEDF_WGC`) is applied to `rho^beta` before FFT. The potential has terms proportional to `alpha*rho^(alpha-1)*FFT(kernel*FFT(rho^beta))` and `beta*rho^(beta-1)*FFT(kernel*FFT(rho^alpha))`.
  - **Arguments:** Same as `WTPotentialPlus`.

- **`FUNCTION WTEnergy(rhoR_SI) RESULT(energy_val)`**:
  - **Description:** Calculates the WT kinetic energy using the formula `cTF * SUM(rhoR_SI^alpha * FFT[ FFT[rhoR_SI^beta] * keKernel(:,:,:,1] ])`. (Note: `keKernel(:,:,:,1)` is the WT kernel).
  - **Arguments:** `rhoR_SI :: REAL(KIND=DP), DIMENSION(:,:,:), INTENT(IN)`: Spin-independent electron density.

- **`FUNCTION WTPotential(rho) RESULT(potential_val)`**:
  - **Description:** Calculates the WT potential using the formula involving terms like `alpha*rho^(alpha-1)*FFT(FFT(rho^beta)*kernel)` and `beta*rho^(beta-1)*FFT(FFT(rho^alpha)*kernel)`.
  - **Arguments:** `rho :: REAL(KIND=DP), DIMENSION(:,:,:), INTENT(IN)`.

- **`FUNCTION WTStress(rhoReal, energy) RESULT(stress_tensor)`**:
  - **Description:** Calculates the WT KEDF contribution to the stress tensor. This involves terms related to the derivative of the Lindhard function (`GPrime`) and depends on whether `rho0` is held constant (`hold0` flag).
  - **Arguments:**
    - `rhoReal :: REAL(KIND=DP), DIMENSION(:,:,:), INTENT(IN)`: Spin-independent electron density.
    - `energy :: REAL(KIND=DP), INTENT(IN)`: Pre-calculated WT energy.

# Important Variables/Constants

- **Imported KEDF Parameters & Kernel:**
    - `alpha, beta :: REAL(KIND=DP)` (from `KEDF_WTkernel`): Exponents for the density terms `rho^alpha` and `rho^beta` in the WT functional.
    - `keKernel :: REAL(KIND=DP), ALLOCATABLE, DIMENSION(:,:,:,:)` (from `KEDF_WTkernel`): The nonlocal kinetic energy kernel in reciprocal space. Specifically, `keKernel(:,:,:,1)` is used as the WT kernel. This kernel is generated by routines in the `KEDF_WTkernel` module.
    - `cTF :: REAL(KIND=DP)` (from `KEDF_WGC`, which likely gets it from `KEDF_TF`): The Thomas-Fermi constant `(3/10)*(3*pi^2)^(2/3)`.
- **Imported System Variables:**
    - `rho0, rhoS :: REAL(KIND=DP)` (from `SYS`): Reference densities. `rho0` is used in `WTStress` to define `kF`. `rhoS` is likely used by `KEDF_WTkernel` during the generation of `keKernel`.
    - `hold0 :: LOGICAL` (from `SYS`): A flag indicating if `rho0` is held constant during cell variations, which affects the stress tensor calculation.
- **Vacuum Cutoff (from `KEDF_WGC`):**
    - `CutoffFunc, CutoffFuncD`: Functions used to apply cutoff in vacuum regions if `vacCutoff` is true in `WTPotPlus`.

# Usage Examples

[If applicable, provide examples or code snippets demonstrating how to use the functions, classes, or modules in the file.]

# Dependencies and Interactions

- **`Constants`**: For `DP`.
- **`OutputFiles`**: For `outputUnit`.
- **`KEDF_WGC`**: For `CutoffFunc`, `CutoffFuncD` (vacuum correction utilities), and `cTF` (Thomas-Fermi constant).
- **`KEDF_WTkernel`**: Critically for the `alpha` and `beta` parameters and the pre-computed `keKernel` array which contains the WT kernel.
- **`Fourier_NEW`**: The `WTPotPlus` routine uses `FFT_NEW` (via the generic `FFT` interface if `Fourier_NEW` is the active FFT module) for its convolutions.
- **`Output`**: For `WrtOut`, `message`, `Error`.
- **`Fourier`**: For the generic `FFT` interface.
- **`PlaneWave`**: For `qTable` (G-vector magnitudes), `qMask`, and `qVectors` (G-vector components), used in `WTStress`.
- **`CellInfo`**: For grid dimensions and `cell` variable (used in `WTStress`).
- **`SYS`**: For reference densities `rho0`, `rhoS`, and the `hold0` flag.
- **`MathFunctions`**: For `GPrime` (derivative of Lindhard function, used in `WTStress`).
- **`KEDF_TF`**: Imports `lambda` (in `WTStress`), but it is not used.
- **`KEDF_VW`**: Imports `mu` (in `WTStress`), but it is not used.

**Workflow:**
1.  The WT kernel (`keKernel(:,:,:,1)`) and parameters (`alpha`, `beta`) must be initialized by `KEDF_WTkernel` before this module's routines are called.
2.  `WTPotentialPlus` (which calls `WTPotPlus`) is the main entry point for calculating the WT potential and energy.
3.  `WTPotPlus` performs convolutions of `rho^alpha` and `rho^beta` with the kernel using FFTs. Vacuum corrections are applied if specified.
4.  `WTEnergy` and `WTPotential` are older function forms, likely superseded by `WTPotPlus`.
5.  `WTStress` calculates the stress contribution, using `rho0` to define a Fermi wavevector `kF` which scales `eta = |G| / (2*kF)` for the Lindhard function derivative `GPrime`.

The `KEDF_WT` module provides the computational routines for the Wang-Teter KEDF, relying on `KEDF_WTkernel` for the actual kernel data and parameters.
